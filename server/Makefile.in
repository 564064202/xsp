MCS=@MCS@
MCSFLAGS+= -debug+ -debug:full -nologo
MKINSTALLDIRS=@top_builddir@mkinstalldirs 
DISTFILES=Makefile.in $(COMMON_SOURCES) $(XSP_ONLY) $(MODMONO_ONLY)

# 
XSP_REFERENCES= System.Web
MODMONO_SERVER_REFERENCES= System.Web Mono.Posix
XSP_REFS= $(addsuffix .dll, $(addprefix -r:, $(XSP_REFERENCES)))
MODMONO_SERVER_REFS= $(addsuffix .dll, $(addprefix -r:, $(MODMONO_SERVER_REFERENCES)))

COMMON_SOURCES= IApplicationHost.cs \
	  XSPApplicationHost.cs \
	  MonoWorkerRequest.cs \
	  InitialWorkerRequest.cs \
	  Tracing.cs \
	  server.cs

XSP_ONLY= AssemblyInfo.cs.in \
	  XSPWorkerRequest.cs

XSP_SOURCES = $(COMMON_SOURCES) $(XSP_ONLY:.in=)

MODMONO_ONLY= ModMonoRequest.cs \
	      ModMonoWorkerRequest.cs \
	      AssemblyInfoModMono.cs.in

MODMONO_SERVER_SOURCES =  $(COMMON_SOURCES) $(MODMONO_ONLY:.in=)

EXES = xsp.exe mod-mono-server.exe
LOCAL_BIN_DIR=$(DESTDIR)$(prefix)/bin

.PHONY: all install clean uninstall trace

all: $(EXES)

install: $(EXES)
	$(MKINSTALLDIRS) $(LOCAL_BIN_DIR)
	cp $(EXES) $(LOCAL_BIN_DIR)

xsp.exe: $(XSP_SOURCES)
	$(MCS) $(MCSFLAGS) $(XSP_REFS) /out:$@ $^

mod-mono-server.exe: $(MODMONO_SERVER_SOURCES)
	$(MCS) $(MCSFLAGS) $(MODMONO_SERVER_REFS) /d:MODMONO_SERVER /out:$@ $^

trace: 
	rm -f $(EXES)
	$(MAKE) MCSFLAGS=/d:WEBTRACE MCS=$(MCS)

clean:
	rm -f $(EXES) *~ *.pdb

uninstall:
	-test -d $(LOCAL_BIN_DIR) && cd $(LOCAL_BIN_DIR) && rm -f $(EXES)

distdir:
	$(MKINSTALLDIRS) $(distdir)
	cp $(DISTFILES) $(distdir)

