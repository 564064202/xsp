MCS=@MCS@
MCSFLAGS+= -debug+ -debug:full -nologo
PREFIX=@prefix@
DESTDIR=
MKINSTALLDIRS=@top_builddir@mkinstalldirs 
DISTFILES=Makefile.in $(XSP_SOURCES) ModMonoRequest.cs ModMonoWorkerRequest.cs

# 
XSP_REFERENCES= System.Web
MODMONO_SERVER_REFERENCES= System.Web Mono.Posix
XSP_REFS= $(addsuffix .dll, $(addprefix -r:, $(XSP_REFERENCES)))
MODMONO_SERVER_REFS= $(addsuffix .dll, $(addprefix -r:, $(MODMONO_SERVER_REFERENCES)))

XSP_SOURCES = AssemblyInfo.cs \
          IApplicationHost.cs \
	  XSPApplicationHost.cs \
	  MonoWorkerRequest.cs \
	  XSPWorkerRequest.cs \
	  InitialWorkerRequest.cs \
	  Tracing.cs \
          server.cs

MODMONO_SERVER_SOURCES =  IApplicationHost.cs \
			  MonoWorkerRequest.cs \
			  ModMonoRequest.cs \
			  ModMonoWorkerRequest.cs \
			  XSPApplicationHost.cs \
			  InitialWorkerRequest.cs \
			  Tracing.cs \
			  server.cs

EXES = xsp.exe mod-mono-server.exe
LOCAL_BIN_DIR=$(DESTDIR)$(PREFIX)/bin

.PHONY: all install clean uninstall trace

all: $(EXES)

install: $(EXES)
	$(MKINSTALLDIRS) $(LOCAL_BIN_DIR)
	cp $(EXES) $(LOCAL_BIN_DIR)

xsp.exe: $(XSP_SOURCES)
	$(MCS) $(MCSFLAGS) $(XSP_REFS) /out:$@ $^

mod-mono-server.exe: $(MODMONO_SERVER_SOURCES)
	$(MCS) $(MCSFLAGS) $(MODMONO_SERVER_REFS) /d:MODMONO_SERVER /out:$@ $^

trace: 
	rm -f $(EXES)
	$(MAKE) MCSFLAGS=/d:WEBTRACE MCS=$(MCS)

clean:
	rm -f $(EXES) *~ *.pdb

uninstall:
	-test -d $(LOCAL_BIN_DIR) && cd $(LOCAL_BIN_DIR) && rm -f $(EXES)

distdir:
	$(MKINSTALLDIRS) $(DESTDIR)$(PREFIX)/server
	cp $(DISTFILES) $(DESTDIR)$(PREFIX)/server

